name: Deploy Project

on:
  push:
    branches:
      - main
      - gha-fixing

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: DTU Hosting
    
    steps:
    - name: Create .env.prod file
      run: |
        touch .env.prod
        echo "ENVIRONMENT=Production" >> .env.prod
        echo "FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }}" >> .env.prod
        echo "DB_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}" >> .env.prod
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env.prod
        echo "CONNECTION_STRING=Server=${{ vars.DB_TYPE }};Database=${{ secrets.DB_NAME }};User=root;Password=${{ secrets.DB_ROOT_PASSWORD }};Port=${{ vars.DB_PORT }};" >> .env.prod
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.prod
        echo "EMAIL_VERIFICATION_URL=https://${{ vars.HOST }}:${{ vars.BACKEND_HTTPS_PORT }}/api/auth/verify-email" >> .env.prod
        echo "SMTP_SERVER=${{ vars.SMTP_SERVER }}" >> .env.prod
        echo "SMTP_PORT=${{ vars.SMTP_PORT }}" >> .env.prod
        echo "SENDER_EMAIL=noreply.gametogether@gmail.com" >> .env.prod
        echo "SENDER_PASSWORD=${{ secrets.SMTP_PASSWORD }}" >> .env.prod
        echo "ASPNETCORE_URLS=https://+:7191" >> .env.prod
        echo "ASPNETCORE_Kestrel__Certificates__Default__Path=" >> .env.prod

#    - name: Set up SSL certificate

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.2.1
      with:
        host: ${{ vars.HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # DEBUG
          echo "pwd:"
          pwd
          echo "ls -al:"
          ls -al

          # GIT CLONE
          if [ -d "GameTogether-FrontEnd" ]; then
            echo "Repository already exists. Pulling latest changes..."
            cd GameTogether-FrontEnd
            git pull
            git submodule update --init --recursive
          else
            echo "Repository not found. Cloning..."
            git clone https://github.com/Frebbers/GameTogether-FrontEnd --recursive-submodules
            cd GameTogether-FrontEnd
          fi

          # DOCKER COMPOSE
          echo "running docker compose down"
          docker compose -f Docker-Compose.yml down
          echo "running docker compose up"
          docker compose -f Docker-Compose.yml up -d --build
          echo "finished"
          
